/*
        BestInPlace (for jQuery)
        version: 0.1.0 (01/01/2011)
        @requires jQuery >= v1.4
        @requires jQuery.purr to display pop-up windows

        By Bernat Farrero based on the work of Jan Varwig.
        Examples at http://bernatfarrero.com

        Licensed under the MIT:
          http://www.opensource.org/licenses/mit-license.php

        Usage:

        Attention.
        The format of the JSON object given to the select inputs is the following:
        [["key", "value"],["key", "value"]]
        The format of the JSON object given to the checkbox inputs is the following:
        ["falseValue", "trueValue"]
*/
function BestInPlaceEditor(e){this.element=jQuery(e),this.initOptions(),this.bindForm(),this.initNil(),$(this.activator).bind("click",{editor:this},this.clickHandler)}BestInPlaceEditor.prototype={activate:function(){var e=this.isNil?"":this.element.html();this.oldValue=e,$(this.activator).unbind("click",this.clickHandler),this.activateForm()},abort:function(){this.isNil?this.element.html(this.nil):this.element.html(this.oldValue),$(this.activator).bind("click",{editor:this},this.clickHandler)},update:function(){var e=this;if(this.formType in{input:1,textarea:1}&&this.getValue()==this.oldValue)return this.abort(),!0;this.isNil=!1,e.ajax({type:"post",dataType:"text",data:e.requestData(),success:function(t){e.loadSuccessCallback(t)},error:function(t,n){e.loadErrorCallback(t,n)}});if(this.formType=="select"){var t=this.getValue();$.each(this.values,function(n,r){t==r[0]&&e.element.html(r[1])})}else this.formType=="checkbox"?e.element.html(this.getValue()?this.values[1]:this.values[0]):e.element.html(this.getValue()!=""?this.getValue():this.nil)},activateForm:function(){alert("The form was not properly initialized. activateForm is unbound")},initOptions:function(){var e=this;e.element.parents().each(function(){e.url=e.url||jQuery(this).attr("data-url"),e.collection=e.collection||jQuery(this).attr("data-collection"),e.formType=e.formType||jQuery(this).attr("data-type"),e.objectName=e.objectName||jQuery(this).attr("data-object"),e.attributeName=e.attributeName||jQuery(this).attr("data-attribute"),e.nil=e.nil||jQuery(this).attr("data-nil"),e.inner_class=e.inner_class||jQuery(this).attr("data-inner-class"),e.html_attrs=e.html_attrs||jQuery(this).attr("data-html-attrs")}),e.element.parents().each(function(){var t=this.id.match(/^(\w+)_(\d+)$/i);t&&(e.objectName=e.objectName||t[1])}),e.url=e.element.attr("data-url")||e.url||document.location.pathname,e.collection=e.element.attr("data-collection")||e.collection,e.formType=e.element.attr("data-type")||e.formtype||"input",e.objectName=e.element.attr("data-object")||e.objectName,e.attributeName=e.element.attr("data-attribute")||e.attributeName,e.activator=e.element.attr("data-activator")||e.element,e.nil=e.element.attr("data-nil")||e.nil||"-",e.inner_class=e.element.attr("data-inner-class")||e.inner_class||null,e.html_attrs=e.element.attr("data-html-attrs")||e.html_attrs,e.element.attr("data-sanitize")?e.sanitize=e.element.attr("data-sanitize")=="true":e.sanitize=!0,(e.formType=="select"||e.formType=="checkbox")&&e.collection!==null&&(e.values=jQuery.parseJSON(e.collection))},bindForm:function(){this.activateForm=BestInPlaceEditor.forms[this.formType].activateForm,this.getValue=BestInPlaceEditor.forms[this.formType].getValue},initNil:function(){this.element.html()==""&&(this.isNil=!0,this.element.html(this.nil))},getValue:function(){alert("The form was not properly initialized. getValue is unbound")},sanitizeValue:function(e){if(this.sanitize){var t=document.createElement("DIV");t.innerHTML=e,e=t.textContent||t.innerText}return jQuery.trim(e)},requestData:function(){csrf_token=$("meta[name=csrf-token]").attr("content"),csrf_param=$("meta[name=csrf-param]").attr("content");var e="_method=put";return e+="&"+this.objectName+"["+this.attributeName+"]="+encodeURIComponent(this.getValue()),csrf_param!==undefined&&csrf_token!==undefined&&(e+="&"+csrf_param+"="+encodeURIComponent(csrf_token)),e},ajax:function(e){return e.url=this.url,e.beforeSend=function(e){e.setRequestHeader("Accept","application/json")},jQuery.ajax(e)},loadSuccessCallback:function(e){this.element.html(e[this.objectName]),this.element.trigger($.Event("ajax:success"),e),$(this.activator).bind("click",{editor:this},this.clickHandler)},loadErrorCallback:function(e,t){this.element.html(this.oldValue),$.each(jQuery.parseJSON(e.responseText),function(e,t){typeof t=="object"&&(t=e+" "+t.toString());var n=$("<span class='flash-error'></span>").html(t);n.purr()}),$(this.activator).bind("click",{editor:this},this.clickHandler)},clickHandler:function(e){e.data.editor.activate()},setHtmlAttributes:function(){var e=this.element.find(this.formType),t=jQuery.parseJSON(this.html_attrs);for(var n in t)e.attr(n,t[n])}},BestInPlaceEditor.forms={input:{activateForm:function(){var e='<form class="form_in_place" action="javascript:void(0)" style="display:inline;">';e+='<input type="text" name="'+this.attributeName+'" value="'+this.sanitizeValue(this.oldValue)+'"',this.inner_class!=null&&(e+=' class="'+this.inner_class+'"'),e+="></form>",this.element.html(e),this.setHtmlAttributes(),this.element.find("input")[0].select(),this.element.find("form").bind("submit",{editor:this},BestInPlaceEditor.forms.input.submitHandler),this.element.find("input").bind("blur",{editor:this},BestInPlaceEditor.forms.input.inputBlurHandler),this.element.find("input").bind("keyup",{editor:this},BestInPlaceEditor.forms.input.keyupHandler)},getValue:function(){return this.sanitizeValue(this.element.find("input").val())},inputBlurHandler:function(e){e.data.editor.update()},submitHandler:function(e){e.data.editor.update()},keyupHandler:function(e){e.keyCode==27&&e.data.editor.abort()}},select:{activateForm:function(){var e="<form action='javascript:void(0)' style='display:inline;'><select>",t="",n=this.oldValue;$.each(this.values,function(r,i){t=i[1]==n?"selected='selected'":"",e+="<option value='"+i[0]+"' "+t+">"+i[1]+"</option>"}),e+="</select></form>",this.element.html(e),this.setHtmlAttributes(),this.element.find("select").bind("change",{editor:this},BestInPlaceEditor.forms.select.blurHandler),this.element.find("select").bind("blur",{editor:this},BestInPlaceEditor.forms.select.blurHandler),this.element.find("select").bind("keyup",{editor:this},BestInPlaceEditor.forms.select.keyupHandler),this.element.find("select")[0].focus()},getValue:function(){return this.sanitizeValue(this.element.find("select").val())},blurHandler:function(e){e.data.editor.update()},keyupHandler:function(e){e.keyCode==27&&e.data.editor.abort()}},checkbox:{activateForm:function(){var e=Boolean(this.oldValue!=this.values[1]),t=e?this.values[1]:this.values[0];this.element.html(t),this.setHtmlAttributes(),this.update()},getValue:function(){return Boolean(this.element.html()==this.values[1])}},textarea:{activateForm:function(){width=this.element.css("width"),height=this.element.css("height");var e='<form action="javascript:void(0)" style="display:inline;"><textarea>';e+=this.sanitizeValue(this.oldValue),e+="</textarea></form>",this.element.html(e),this.setHtmlAttributes(),jQuery(this.element.find("textarea")[0]).css({"min-width":width,"min-height":height}),jQuery(this.element.find("textarea")[0]).elastic(),this.element.find("textarea")[0].focus(),this.element.find("textarea").bind("blur",{editor:this},BestInPlaceEditor.forms.textarea.blurHandler),this.element.find("textarea").bind("keyup",{editor:this},BestInPlaceEditor.forms.textarea.keyupHandler)},getValue:function(){return this.sanitizeValue(this.element.find("textarea").val())},blurHandler:function(e){e.data.editor.update()},keyupHandler:function(e){e.keyCode==27&&BestInPlaceEditor.forms.textarea.abort(e.data.editor)},abort:function(e){confirm("Are you sure you want to discard your changes?")&&e.abort()}}},jQuery.fn.best_in_place=function(){return this.each(function(){jQuery(this).data("bestInPlaceEditor")||jQuery(this).data("bestInPlaceEditor",new BestInPlaceEditor(this))}),this},function(e){e.fn.extend({elastic:function(){var t=["paddingTop","paddingRight","paddingBottom","paddingLeft","fontSize","lineHeight","fontFamily","width","fontWeight"];return this.each(function(){function f(e,t){curratedHeight=Math.floor(parseInt(e,10)),n.height()!=curratedHeight&&n.css({height:curratedHeight+"px",overflow:t})}function l(){var e=n.val().replace(/&/g,"&amp;").replace(/  /g,"&nbsp;").replace(/<|>/g,"&gt;").replace(/\n/g,"<br />"),t=r.html().replace(/<br>/ig,"<br />");if(e+"&nbsp;"!=t){r.html(e+"&nbsp;");if(Math.abs(r.height()+i-n.height())>3){var u=r.height()+i;u>=o?f(o,"auto"):u<=s?f(s,"hidden"):f(u,"hidden")}}}if(this.type!="textarea")return!1;var n=e(this),r=e("<div />").css({position:"absolute",display:"none","word-wrap":"break-word"}),i=parseInt(n.css("line-height"),10)||parseInt(n.css("font-size"),"10"),s=parseInt(n.css("height"),10)||i*3,o=parseInt(n.css("max-height"),10)||Number.MAX_VALUE,u=0,a=0;o<0&&(o=Number.MAX_VALUE),r.appendTo(n.parent());var a=t.length;while(a--)r.css(t[a].toString(),n.css(t[a].toString()));n.css({overflow:"hidden"}),n.bind("keyup change cut paste",function(){l()}),n.bind("blur",function(){r.height()<o&&(r.height()>s?n.height(r.height()):n.height(s))}),n.live("input paste",function(e){setTimeout(l,250)}),l()})}})}(jQuery);